<!DOCTYPE html>
<html lang="ja">

<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QCTM9NEWRK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QCTM9NEWRK');
</script>

  <meta charset="UTF-8">
  <title>èªå®šè©¦é¨“ - ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒã‚¹ã‚¿ãƒ¼</title>
  <link rel="stylesheet" href="mainframe.css">
  <link rel="stylesheet" href="keyboard.css?v=2">
  <link rel="stylesheet" href="start.css">
  <link rel="stylesheet" href="common.css">
  <style>
    /* â–¼ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä½ç½®èª¿æ•´ (ãƒãƒ©ãƒ³ã‚¹èª¿æ•´) */
    .content-card,
    .mainframe-container,
    .exam-header {
      max-width: 900px !important;
      margin: 10px auto !important;
      box-sizing: border-box;
    }

    /* è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ«ï¼šä¸­æ­¢ãƒœã‚¿ãƒ³ãªã© */
    .exam-actions {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }

    .btn-secondary {
      background: #64748b !important;
      color: white !important;
      padding: 10px 20px !important;
      border-radius: 8px !important;
      text-decoration: none !important;
      font-weight: bold !important;
      font-size: 0.9rem !important;
      transition: opacity 0.2s;
    }

    .btn-abort {
      background: #ef4444 !important;
      color: white !important;
      padding: 10px 20px !important;
      border-radius: 8px !important;
      text-decoration: none !important;
      font-weight: bold !important;
      font-size: 0.9rem !important;
      transition: opacity 0.2s;
    }

    .btn-secondary:hover,
    .btn-abort:hover {
      opacity: 0.8;
    }

    /* ç®—å‡ºä¸­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .pulse {
      animation: pulse-opacity 1.5s infinite ease-in-out;
    }

    @keyframes pulse-opacity {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.4;
      }

      100% {
        opacity: 1;
      }
    }
  </style>
  <link rel="canonical" href="https://typingmasterneo.com/exam.html">
</head>

<body>

  <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="nav">
    <a href="index.html">Top</a>
    <a href="home.html">ãƒ–ãƒ©ã‚¤ãƒ³ãƒ‰ã‚¿ãƒƒãƒã¨ã¯</a>
    <a href="about.html">ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</a>
    <a href="results.html">æˆé•·åˆ†æãƒœãƒ¼ãƒ‰</a>
    <a href="contact.html">ãŠå•ã„åˆã‚ã›</a>
    <a href="privacy.html">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
    <span id="visit-counter">è¨ªå•æ•°ï¼š--</span>
  </div>

  <div class="exam-header">
    <h1 id="examTitle" style="margin:0; font-size:1.4rem;">èªå®šè©¦é¨“</h1>
    <div class="round-indicator">
      <div id="dot1" class="round-dot"></div>
      <div id="dot2" class="round-dot"></div>
    </div>
  </div>

  <div id="uiBar" style="text-align:center; padding: 10px;">
    <div id="timerDisplay" style="font-size: 2.8rem; font-weight: bold; color: #00796b; margin-bottom: 5px;">30</div>

    <div id="controlPanel">
      <!-- å¾…æ©Ÿä¸­ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹ã‚¨ãƒªã‚¢ -->
      <div id="idleOverlay">
        <div id="spacePrompt"
          style="margin-bottom: 25px; color: #1e293b; font-weight: 800; font-size: 1.8rem; letter-spacing: 0.05em; line-height: 1.4;">
          ã‚¹ãƒšãƒ¼ã‚¹ãƒãƒ¼ã‚’æŠ¼ã™ã¨è©¦é¨“ãŒé–‹å§‹ã—ã¾ã™
        </div>
        <div class="exam-actions">
          <a href="certification.html" class="btn-secondary">ãƒ¬ãƒ™ãƒ«é¸æŠã«æˆ»ã‚‹</a>
          <a href="certification.html" class="btn-abort">è©¦é¨“ã‚’ä¸­æ­¢ã™ã‚‹</a>
        </div>
      </div>

      <!-- è©¦é¨“ä¸­ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹ã‚¨ãƒªã‚¢ -->
      <div id="playingOverlay" style="display: none;">
        <div class="exam-actions">
          <a href="certification.html" class="btn-abort">è©¦é¨“ã‚’ä¸­æ­¢ã—ã¦æˆ»ã‚‹</a>
        </div>
      </div>
    </div>
  </div>

  <div class="three-col">
    <div class="side-ad"></div>
    <div class="typing-center">
      <div class="center-card question-card" id="questionCard">
        <h1 id="questionHira"></h1>
        <h2 id="questionRoma" style="color: #64748b;"></h2>
      </div>

      <!-- ç®—å‡ºä¸­ã‚«ãƒ¼ãƒ‰ -->
      <div class="center-card question-card" id="calculatingCard" style="display:none; text-align:center;">
        <h2 style="margin:0 0 10px 0; font-size:1.6rem; color:#1e293b;">ãŠç–²ã‚Œæ§˜ã§ã—ãŸ</h2>
        <p style="margin:0; font-size:1.2rem; color:#64748b; font-weight:bold;" class="pulse">ä»Šã®ã‚ãªãŸã®ãƒ©ãƒ³ã‚¯ã‚’ç®—å‡ºã—ã¦ã„ã¾ã™...</p>
      </div>

      <div id="keyboardBox"></div>
    </div>
    <div class="side-ad"></div>
  </div>

  <div id="resultOverlay" class="result-overlay" style="display:none;">
    <div class="result-content">
      <div id="resTitle" class="res-title"></div>
      <div id="resStats" class="res-stats"></div>
      <div id="resAction"></div>
    </div>
  </div>

  <script src="keyboard.js"></script>
  <script>
    let problems = [];
    let currentIndex = 0;
    let currentRoma = "";
    let displayRoma = "";
    let isGameStarted = false;
    let correctCount = 0;
    let attemptedCount = 0;

    let examRound = 1;
    let examLevel = "";
    let resultsHistory = [];
    let timeLeft = 30;
    let timer = null;

    async function init() {
      const params = new URLSearchParams(location.search);
      examLevel = params.get("level") || "syokyu";
      const levelNames = { syokyu: "åˆç´š1ç´š", syokyu2: "åˆç´š2ç´š", cyukyu1: "ä¸­ç´š", jyokyu1: "ä¸Šç´š" };
      document.getElementById("examTitle").textContent = `${levelNames[examLevel]} èªå®šè©¦é¨“`;

      const res = await fetch(`${examLevel}.txt`);
      const text = await res.text();
      problems = text.trim().split("\n").map(l => {
        const [h, r] = l.split(",");
        return { hira: h, roma: r };
      });
      prepareRound();
    }

    function prepareRound() {
      // ç”»é¢çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById("questionCard").style.display = "flex";
      document.getElementById("calculatingCard").style.display = "none";
      document.getElementById("keyboardBox").style.display = "inline-block";
      document.getElementById("timerDisplay").style.opacity = "1";

      document.getElementById(`dot${examRound}`).classList.add("active");
      document.getElementById("timerDisplay").textContent = "30";
      document.getElementById("idleOverlay").style.display = "block";
      document.getElementById("playingOverlay").style.display = "none";
      showProblem();
    }

    function runRound() {
      document.getElementById("idleOverlay").style.display = "none";
      document.getElementById("playingOverlay").style.display = "block";
      isGameStarted = true;
      correctCount = 0;
      attemptedCount = 0;
      timeLeft = 30;
      timer = setInterval(() => {
        timeLeft--;
        document.getElementById("timerDisplay").textContent = timeLeft;
        if (timeLeft <= 0) endRound();
      }, 1000);
      if (window.buildKeyboard) buildKeyboard();
    }

    function endRound() {
      clearInterval(timer);
      isGameStarted = false;
      const acc = attemptedCount ? Math.floor((correctCount / attemptedCount) * 100) : 0;
      resultsHistory.push({ score: correctCount, acc: acc });
      saveToGeneralStats(correctCount, acc);

      if (examRound < 2) {
        showMidResult();
      } else {
        // 2å›ç›®çµ‚äº†æ™‚ï¼šç®—å‡ºæ¼”å‡ºã¸
        showCalculatingState();
      }
    }

    function showCalculatingState() {
      // UIã‚’ã€Œç®—å‡ºä¸­ã€ã«åˆ‡ã‚Šæ›¿ãˆ
      document.getElementById("questionCard").style.display = "none";
      document.getElementById("keyboardBox").style.display = "none";
      document.getElementById("calculatingCard").style.display = "flex";
      document.getElementById("timerDisplay").style.opacity = "0.2";

      // 2.5ç§’å¾Œã«æœ€çµ‚çµæœã‚’è¡¨ç¤º
      setTimeout(() => {
        showFinalResult();
      }, 2500);
    }

    function saveToGeneralStats(score, acc) {
      const raw = localStorage.getItem('typingTestResults');
      const data = raw ? JSON.parse(raw) : [];
      data.push({
        date: new Date().toISOString(),
        score: score * 10,
        correctCount: score,
        attemptedCount: attemptedCount,
        level: examLevel + "_exam",
        timeLimit: 30
      });
      localStorage.setItem('typingTestResults', JSON.stringify(data));
    }

    function showMidResult() {
      const res = resultsHistory[0];
      const overlay = document.getElementById("resultOverlay");
      overlay.style.display = "flex";
      document.getElementById("resTitle").textContent = "1å›ç›® çµ‚äº†";
      document.getElementById("resStats").innerHTML = `
        <div style="margin-bottom:15px;">
          <div style="font-size:0.9rem; color:#64748b;">æ­£è§£ã‚­ãƒ¼æ•°</div>
          <div style="font-size:1.8rem; font-weight:bold;">${res.score} <span style="font-size:1rem;">ã‚­ãƒ¼</span></div>
        </div>
        <div style="margin-bottom:15px;">
          <div style="font-size:0.9rem; color:#64748b;">æ­£ç¢ºã•</div>
          <div style="font-size:1.8rem; font-weight:bold;">${res.acc} <span style="font-size:1rem;">%</span></div>
        </div>
      `;
      document.getElementById("resAction").innerHTML = `<button class="res-btn" onclick="nextRound()">2å›ç›®ã¸é€²ã‚€</button>`;
    }

    function nextRound() {
      document.getElementById("resultOverlay").style.display = "none";
      examRound = 2;
      prepareRound();
    }

    function showFinalResult() {
      // ç®—å‡ºä¸­ã‚«ãƒ¼ãƒ‰ã‚’éš ã™
      document.getElementById("calculatingCard").style.display = "none";

      const avgScore = (resultsHistory[0].score + resultsHistory[1].score) / 2;
      const avgAcc = (resultsHistory[0].acc + resultsHistory[1].acc) / 2;
      const passScore = 50; // â€»è¦ä»¶ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„ï¼ˆä¾‹:åˆç´š1ãªã‚‰30ã§ç°¡å˜ã«ã™ã‚‹ãªã©ï¼‰
      const passAcc = 95;
      const isPass = (avgScore >= passScore && avgAcc >= passAcc);
      const overlay = document.getElementById("resultOverlay");
      overlay.style.display = "flex";
      const title = document.getElementById("resTitle");
      title.textContent = isPass ? "ğŸ‰ åˆæ ¼ï¼" : "ä¸åˆæ ¼";
      title.className = "res-title " + (isPass ? "pass" : "fail");

      // åˆæ ¼æ™‚ã®å‡¦ç†ï¼šç§°å·ã‚’ä¿å­˜
      if (isPass) {
        const levelMap = { syokyu: "åˆç´š1", syokyu2: "åˆç´š2", cyukyu1: "ä¸­ç´š", jyokyu1: "ä¸Šç´š" };
        const badgeName = (levelMap[examLevel] || "èªå®š") + " åˆæ ¼";

        const currentTitles = JSON.parse(localStorage.getItem('typingTitles') || '[]');
        if (!currentTitles.includes(badgeName)) {
          currentTitles.push(badgeName);
          localStorage.setItem('typingTitles', JSON.stringify(currentTitles));
        }
      }

      document.getElementById("resStats").innerHTML = `
        <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">å¹³å‡çµæœ</div>
        <div style="background:#f8fafc; padding:15px; border-radius:10px;">
          <div style="margin-bottom:10px;">ã‚­ãƒ¼æ•°: <strong>${avgScore}</strong> / ${passScore}ä»¥ä¸Š</div>
          <div>æ­£ç¢ºã•: <strong>${avgAcc}%</strong> / ${passAcc}%ä»¥ä¸Š</div>
        </div>
      `;
      document.getElementById("resAction").innerHTML = `<a href="certification.html" class="res-btn">èªå®šä¸€è¦§ã«æˆ»ã‚‹</a>`;
    }

    function showProblem() {
      const p = problems[Math.floor(Math.random() * problems.length)];
      currentRoma = p.roma.replace(/\s+/g, "");
      displayRoma = p.roma;
      document.getElementById("questionHira").textContent = p.hira;
      document.getElementById("questionRoma").textContent = displayRoma;
    }

    document.addEventListener("keydown", e => {
      const overlay = document.getElementById("resultOverlay");
      const isOverlayVisible = overlay && overlay.style.display !== "none";

      if (!isGameStarted && !isOverlayVisible && e.code === "Space") {
        e.preventDefault();
        runRound();
        return;
      }

      if (!isGameStarted) return;
      const key = e.key.toLowerCase();
      if (key === "shift" || key === "control" || key === "alt") return;
      attemptedCount++;
      if (key === currentRoma[0]) {
        currentRoma = currentRoma.slice(1);
        displayRoma = displayRoma.replace(/^\s*/, "").slice(1);
        document.getElementById("questionRoma").textContent = displayRoma;
        if (currentRoma.length === 0) {
          correctCount++;
          showProblem();
        }
      }
    });

    window.addEventListener("DOMContentLoaded", init);
  </script>

  <script src="start.js"></script>
</body>

</html>