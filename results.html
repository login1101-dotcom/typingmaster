<!DOCTYPE html>
<html lang="ja">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QCTM9NEWRK"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-QCTM9NEWRK');
    </script>

    <meta charset="UTF-8">
    <title>æˆé•·åˆ†æãƒœãƒ¼ãƒ‰ - ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒã‚¹ã‚¿ãƒ¼</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="keyboard.css?v=17">
    <link rel="stylesheet" href="common.css?v=17">

    <style>
        body {
            margin: 0 !important;
            padding-top: 0 !important;
            background: #f1f5f9;
            /* å°‘ã—ã‚°ãƒ¬ãƒ¼ãŒã‹ã£ãŸèƒŒæ™¯ã§è¦‹ã‚„ã™ã */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
        }

        /* â–¼ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .dashboard-wrapper {
            max-width: 1100px;
            margin: 10px auto;
            padding: 0 20px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .dashboard-title {
            font-size: 24px;
            font-weight: bold;
            color: #334155;
        }

        .action-btn {
            cursor: pointer;
            font-size: 14px;
            padding: 6px 16px;
            border-radius: 6px;
            transition: filter 0.2s;
        }

        .action-btn:hover {
            filter: brightness(0.95);
        }

        .reset-btn {
            background: #fee2e2;
            border: 1px solid #f87171;
            color: #991b1b;
            cursor: pointer;
            font-size: 14px;
            padding: 6px 16px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .reset-btn:hover {
            background: #fecaca;
        }

        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-top: 4px solid #cbd5e1;
            text-align: center;
        }

        .stat-label {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: #1e293b;
            line-height: 1.2;
        }

        .stat-unit {
            font-size: 14px;
            color: #64748b;
            margin-left: 4px;
        }

        .stat-sub {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }

        /* ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ */
        .charts-grid {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 15px 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.15);
            height: 200px;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .chart-info {
            width: 20%;
            text-align: left;
            flex-shrink: 0;
        }

        .chart-header {
            font-size: 18px;
            font-weight: bold;
            color: #334155;
            margin-bottom: 8px;
            text-align: left;
        }

        .chart-desc {
            font-size: 12px;
            color: #64748b;
            line-height: 1.5;
        }

        .chart-canvas-wrapper {
            width: 80%;
            height: 100%;
            flex-grow: 1;
        }

        .chart-legend {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: #475569;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        /* ã‚·ãƒ³ãƒ—ãƒ«ãƒãƒƒã‚¸ (ãƒ˜ãƒƒãƒ€ãƒ¼å†…è¡¨ç¤ºç”¨) */
        .simple-badge-list {
            display: flex;
            gap: 8px;
        }

        .simple-badge {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 6px;
            background: #f1f5f9;
            color: #94a3b8;
            border: 1px solid #cbd5e1;
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0.6;
            transition: all 0.3s;
        }

        .simple-badge {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 6px;
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #cbd5e1;
            display: flex;
            align-items: center;
            gap: 6px;
            filter: grayscale(100%);
            opacity: 0.5;
            transition: all 0.3s;
        }

        .simple-badge.active {
            background: #dcfce7;
            color: #15803d;
            border-color: #86efac;
            font-weight: bold;
            filter: none;
            opacity: 1;
            box-shadow: 0 2px 4px rgba(21, 128, 61, 0.1);
        }

        .badge-icon-small {
            font-size: 14px;
        }

        /* ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—å‡¡ä¾‹ã‚¹ã‚¿ã‚¤ãƒ« */
        .heatmap-legend {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            gap: 10px;
            font-size: 14px;
            color: #555;
            padding-bottom: 20px;
        }

        .legend-bar {
            width: 200px;
            height: 12px;
            background: linear-gradient(to right, #ffffff, #e0f2fe, #fef08a, #fdba74, #ef4444);
            border: 1px solid #ccc;
            border-radius: 6px;
        }
    </style>
    <link rel="stylesheet" href="common.css">
    <link rel="canonical" href="https://typingmasterneo.com/results.html">
</head>

<body>

    <div class="nav">
        <a href="index.html">Top</a>
        <a href="home.html">ãƒ–ãƒ©ã‚¤ãƒ³ãƒ‰ã‚¿ãƒƒãƒã¨ã¯</a>
        <a href="about.html">ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</a>
        <a href="results.html" style="font-weight:700; color:#2563eb;">æˆé•·åˆ†æãƒœãƒ¼ãƒ‰</a>
        <a href="contact.html">ãŠå•ã„åˆã‚ã›</a>
        <a href="privacy.html">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
        <span id="visit-counter">è¨ªå•æ•°ï¼š--</span>
    </div>

    <div class="dashboard-wrapper">
        <div class="dashboard-header">
            <div style="display:flex; align-items:center; gap:20px;">
                <div class="dashboard-title">æˆé•·åˆ†æãƒœãƒ¼ãƒ‰</div>
                <!-- ç§°å·ãƒãƒƒã‚¸ (ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤º) -->
                <div class="simple-badge-list">
                    <div id="badge-syokyu" class="simple-badge"><span class="badge-icon-small">ğŸ”°</span> åˆç´š1</div>
                    <div id="badge-syokyu2" class="simple-badge"><span class="badge-icon-small">ğŸŒ¿</span> åˆç´š2</div>
                    <div id="badge-cyukyu1" class="simple-badge"><span class="badge-icon-small">ğŸŒ¸</span> ä¸­ç´š</div>
                    <div id="badge-jyokyu1" class="simple-badge"><span class="badge-icon-small">ğŸ‘‘</span> ä¸Šç´š</div>
                </div>
            </div>

            <div style="display:flex; gap:10px;">
                <button onclick="exportData()" class="action-btn"
                    style="background:#e0f2fe; border:1px solid #7dd3fc; color:#0369a1;">ãƒ‡ãƒ¼ã‚¿ä¿å­˜(DL)</button>
                <button onclick="triggerImport()" class="action-btn"
                    style="background:#f0fdf4; border:1px solid #86efac; color:#15803d;">ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ</button>
                <input type="file" id="importFile" style="display:none;" accept=".json" onchange="importData(this)">
                <button onclick="clearData()" class="reset-btn">å…¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
            </div>
        </div>

        <!-- ç²å¾—ç§°å·ãƒªã‚¹ãƒˆ -->


        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰ -->
        <div class="stats-grid">
            <div class="stat-card" style="border-top-color: #64748b;">
                <div class="stat-label">ãƒˆãƒ¼ã‚¿ãƒ«æŒ‘æˆ¦å›æ•°</div>
                <div class="stat-value"><span id="val-count">--</span><span class="stat-unit">å›</span></div>
            </div>

            <div class="stat-card" style="border-top-color: #3b82f6;">
                <div class="stat-label">æ­£ç¢ºã•</div>
                <div class="stat-value"><span id="val-acc">--</span><span class="stat-unit">%</span></div>
                <div class="stat-sub" id="sub-acc"></div>
            </div>

            <div class="stat-card" style="border-top-color: #7dd3fc;">
                <div class="stat-label">æ­£ç¢ºã•è‡ªå·±ãƒ™ã‚¹ãƒˆ</div>
                <div class="stat-value"><span id="val-best-acc">--</span><span class="stat-unit">%</span></div>
                <div class="stat-sub" id="sub-best-acc"></div>
            </div>

            <div class="stat-card" style="border-top-color: #10b981;">
                <div class="stat-label">ã‚¹ãƒ”ãƒ¼ãƒ‰</div>
                <div class="stat-value"><span id="val-speed">--</span><span class="stat-unit">key/s</span></div>
                <div class="stat-sub" id="sub-speed"></div>
            </div>

            <div class="stat-card" style="border-top-color: #86efac;">
                <div class="stat-label">ã‚¹ãƒ”ãƒ¼ãƒ‰è‡ªå·±ãƒ™ã‚¹ãƒˆ</div>
                <div class="stat-value"><span id="val-best">--</span><span class="stat-unit">key/s</span></div>
                <div class="stat-sub" id="sub-best"></div>
            </div>
        </div>

        <!-- è‹¦æ‰‹ã‚­ãƒ¼ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— -->
        <div id="heatmapSection" style="margin-top:30px; margin-bottom: 40px;">
            <h2
                style="font-size:1.2rem; color:#666; border-bottom:2px solid #ef4444; display:inline-block; padding-bottom:5px; margin-bottom:20px;">
                è‹¦æ‰‹ã‚­ãƒ¼ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— (èµ¤è‰²ãŒæ¿ƒã„ã»ã©è‹¦æ‰‹)
            </h2>
            <div class="center-card keyboard-card">
                <div id="keyboardBox"></div>
            </div>

            <!-- å‡¡ä¾‹ -->
            <div class="heatmap-legend">
                <span>è‰¯ (ç™½)</span>
                <div class="legend-bar"></div>
                <span>(èµ¤) è‹¦æ‰‹</span>
            </div>

            <div style="margin-top:10px; font-size:0.9rem; color:#888;">
                â€»æ­£ç¢ºã•ãƒ‡ãƒ¼ã‚¿ã®è“„ç©ã«ã‚ˆã‚Šè‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™ã€‚
            </div>
        </div>

        <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-info">
                    <div class="chart-header" style="color: #3b82f6;">æ­£ç¢ºã•ã®æ¨ç§»ã¨ç›®æ¨™</div>
                    <div class="chart-desc">
                        æ‰“éµã®æ­£ç¢ºã•ã¯ä¸Šé”ã®æœ€ã‚‚é‡è¦ãªéµã§ã™ã€‚ãƒŸã‚¹ã‚’1%æ¸›ã‚‰ã™ã ã‘ã§ã€å…¥åŠ›ã®ãƒªã‚ºãƒ ãŒè¦‹é•ãˆã‚‹ã»ã©ã‚¹ãƒ ãƒ¼ã‚ºã«ãªã‚Šã¾ã™ã€‚
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item"><span class="legend-color" style="background:#3b82f6;"></span><span>æ­£ç¢ºã•
                                (%)</span></div>
                        <div class="legend-item"><span class="legend-color"
                                style="background:#64748b; border: 1px dashed #64748b; background:transparent;"></span><span>ã“ã‚Œã¾ã§ã®å¹³å‡</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color"
                                style="background:#ef4444; border: 1px dashed #ef4444; background:transparent;"></span>
                            <span id="goal-acc-text">ç›®æ¨™æ­£ç¢ºã• (98%)</span>
                            <button onclick="updateGoal('acc')"
                                style="margin-left:5px; padding:1px 6px; font-size:10px; cursor:pointer; border:1px solid #ccc; border-radius:3px; background:#f8fafc;">å¤‰æ›´ã™ã‚‹</button>
                        </div>
                    </div>
                </div>
                <div class="chart-canvas-wrapper">
                    <canvas id="chartAcc"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-info">
                    <div class="chart-header" style="color: #10b981;">ã‚¹ãƒ”ãƒ¼ãƒ‰ã®æ¨ç§»ã¨ç›®æ¨™</div>
                    <div class="chart-desc">
                        ã‚¹ãƒ”ãƒ¼ãƒ‰ã¯æ­£ç¢ºãªé‹æŒ‡ã®å¾Œã«è‡ªãšã¨ã¤ã„ã¦ãã¾ã™ã€‚ç„¡ç†ã«é€Ÿãæ‰“ã¨ã†ã¨ã›ãšã€æµã‚Œã‚‹ã‚ˆã†ãªãƒªã‚ºãƒ ã‚’å¤§åˆ‡ã«ã—ã¦ãã ã•ã„ã€‚
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item"><span class="legend-color"
                                style="background:#10b981;"></span><span>ä»Šå›ã®è¨˜éŒ²</span></div>
                        <div class="legend-item"><span class="legend-color"
                                style="background:#64748b; border: 1px dashed #64748b; background:transparent;"></span><span>ã“ã‚Œã¾ã§ã®å¹³å‡</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color"
                                style="background:#f59e0b; border: 1px dashed #f59e0b; background:transparent;"></span>
                            <span id="goal-speed-text">ç›®æ¨™ã‚¹ãƒ”ãƒ¼ãƒ‰ (4.0)</span>
                            <button onclick="updateGoal('speed')"
                                style="margin-left:5px; padding:1px 6px; font-size:10px; cursor:pointer; border:1px solid #ccc; border-radius:3px; background:#f8fafc;">å¤‰æ›´ã™ã‚‹</button>
                        </div>
                    </div>
                </div>
                <div class="chart-canvas-wrapper">
                    <canvas id="chartSpeed"></canvas>
                </div>
            </div>
        </div>

        <div id="noData"
            style="display:none; text-align:center; padding:60px 20px; color:#64748b; font-size:1.1rem; background:white; margin-top:30px; border-radius:12px;">
            ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã¾ãšã¯ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒ†ã‚¹ãƒˆã«æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ï¼
            <br><br>
            <a href="index.html" style="color:#3b82f6; text-decoration:underline;">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
        </div>

    </div>

    <script>
        function loadData() {
            const results = JSON.parse(localStorage.getItem('typingTestResults') || '[]');
            if (results.length === 0) {
                document.querySelector('.stats-grid').style.display = 'none';
                document.querySelector('.charts-grid').style.display = 'none';
                document.getElementById('noData').style.display = 'block';
                return;
            }

            results.sort((a, b) => new Date(a.date) - new Date(b.date));

            // ãƒ‡ãƒ¼ã‚¿æ•´å½¢
            const stats = results.map(r => {
                const limit = r.timeLimit || 30;
                const speed = r.correctCount / limit;
                let denominator = r.totalKeyStrokes || r.attemptedCount;
                if (!denominator || denominator < r.correctCount) denominator = r.correctCount;
                const acc = denominator ? (r.correctCount / denominator) * 100 : 0;
                return { speed, acc, date: r.date };
            });

            const count = stats.length;
            const current = stats[count - 1];
            const previous = count > 1 ? stats[count - 2] : null;

            const avgSpeed = stats.reduce((a, b) => a + b.speed, 0) / count;
            const avgAcc = stats.reduce((a, b) => a + b.acc, 0) / count;
            const bestSpeed = Math.max(...stats.map(s => s.speed));

            document.getElementById('val-count').textContent = count;
            document.getElementById('val-acc').textContent = Math.round(current.acc);
            document.getElementById('sub-acc').innerText = `å‰å›: ${previous ? Math.round(previous.acc) : '--'}% / å¹³å‡: ${Math.round(avgAcc)}%`;

            document.getElementById('val-speed').textContent = current.speed.toFixed(1);
            document.getElementById('sub-speed').innerText = `å‰å›: ${previous ? previous.speed.toFixed(1) : '--'} / å¹³å‡: ${avgSpeed.toFixed(1)}`;



            // ã‚¹ãƒ”ãƒ¼ãƒ‰è‡ªå·±ãƒ™ã‚¹ãƒˆ
            document.getElementById('val-best').textContent = bestSpeed.toFixed(1);
            const bestSpeedObj = stats.find(s => s.speed === bestSpeed);
            if (bestSpeedObj) {
                const bestDate = new Date(bestSpeedObj.date);
                document.getElementById('sub-best').innerText = `${bestDate.getMonth() + 1}/${bestDate.getDate()} ã«è¨˜éŒ²`;
            }

            // æ­£ç¢ºã•è‡ªå·±ãƒ™ã‚¹ãƒˆ
            const bestAcc = Math.max(...stats.map(s => s.acc));
            document.getElementById('val-best-acc').textContent = Math.round(bestAcc);
            const bestAccObj = stats.find(s => s.acc === bestAcc);
            if (bestAccObj) {
                const bestDate = new Date(bestAccObj.date);
                document.getElementById('sub-best-acc').innerText = `${bestDate.getMonth() + 1}/${bestDate.getDate()} ã«è¨˜éŒ²`;
            }

            renderCharts(stats, avgSpeed, avgAcc);
            renderBadges();
        }

        let chartSpeedInst = null;
        let chartAccInst = null;

        function updateGoal(type) {
            const currentRaw = localStorage.getItem('typingGoals');
            let goals = currentRaw ? JSON.parse(currentRaw) : { speed: 4.0, acc: 98 };

            if (type === 'speed') {
                const newVal = prompt("æ–°ã—ã„ç›®æ¨™ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (key/s)", goals.speed);
                if (newVal !== null && !isNaN(newVal) && newVal > 0) {
                    goals.speed = parseFloat(newVal);
                    localStorage.setItem('typingGoals', JSON.stringify(goals));
                    loadData();
                }
            } else if (type === 'acc') {
                const newVal = prompt("æ–°ã—ã„ç›®æ¨™æ­£ç¢ºã•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (%)", goals.acc);
                if (newVal !== null && !isNaN(newVal) && newVal > 0 && newVal <= 100) {
                    goals.acc = parseFloat(newVal);
                    localStorage.setItem('typingGoals', JSON.stringify(goals));
                    loadData();
                }
            }
        }

        function renderCharts(stats, avgSpeed, avgAcc) {
            const labels = stats.map(s => {
                const d = new Date(s.date);
                return `${d.getMonth() + 1}/${d.getDate()}-${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
            });

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: { beginAtZero: true, grid: { borderDash: [2, 4] } }
                }
            };

            // ç›®æ¨™å€¤ã®è¨­å®š (ä¿å­˜ã•ã‚ŒãŸå€¤ or ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
            const goalsRaw = localStorage.getItem('typingGoals');
            const goals = goalsRaw ? JSON.parse(goalsRaw) : { speed: 4.0, acc: 98 };
            const GOAL_SPEED = goals.speed;
            const GOAL_ACC = goals.acc;

            // å‡¡ä¾‹ãƒ†ã‚­ã‚¹ãƒˆã®æ›´æ–°
            document.getElementById('goal-acc-text').textContent = `ç›®æ¨™æ­£ç¢ºã• (${GOAL_ACC}%)`;
            document.getElementById('goal-speed-text').textContent = `ç›®æ¨™ã‚¹ãƒ”ãƒ¼ãƒ‰ (${GOAL_SPEED})`;

            // å„ç‚¹ã®ã‚µã‚¤ã‚ºï¼ˆæœ€å¾Œã ã‘å¤§ããã™ã‚‹ï¼‰
            const pointRadiuses = stats.map((_, i) => i === stats.length - 1 ? 8 : 3);
            const pointHoverRadiuses = stats.map((_, i) => i === stats.length - 1 ? 10 : 5);

            // å‰ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (chartSpeedInst) chartSpeedInst.destroy();
            if (chartAccInst) chartAccInst.destroy();

            // 1. ã‚¹ãƒ”ãƒ¼ãƒ‰
            chartSpeedInst = new Chart(document.getElementById('chartSpeed'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ä»Šå›ã®è¨˜éŒ²',
                            data: stats.map(s => s.speed),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: pointRadiuses,
                            pointHoverRadius: pointHoverRadiuses,
                            pointBackgroundColor: '#10b981'
                        },
                        {
                            label: 'ã“ã‚Œã¾ã§ã®å¹³å‡',
                            data: Array(stats.length).fill(avgSpeed),
                            borderColor: '#64748b',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            borderWidth: 2
                        },
                        {
                            label: `ç›®æ¨™ã‚¹ãƒ”ãƒ¼ãƒ‰ (${GOAL_SPEED})`,
                            data: Array(stats.length).fill(GOAL_SPEED),
                            borderColor: '#f59e0b',
                            borderDash: [2, 2],
                            pointRadius: 0,
                            fill: false,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        y: {
                            min: 0,
                            max: 6
                        }
                    }
                }
            });

            // 2. æ­£ç¢ºã•
            chartAccInst = new Chart(document.getElementById('chartAcc'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'æ­£ç¢ºã• (%)',
                            data: stats.map(s => s.acc),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: pointRadiuses,
                            pointHoverRadius: pointHoverRadiuses,
                            pointBackgroundColor: '#3b82f6'
                        },
                        {
                            label: 'ã“ã‚Œã¾ã§ã®å¹³å‡',
                            data: Array(stats.length).fill(avgAcc),
                            borderColor: '#64748b',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            borderWidth: 2
                        },
                        {
                            label: `ç›®æ¨™æ­£ç¢ºã• (${GOAL_ACC}%)`,
                            data: Array(stats.length).fill(GOAL_ACC),
                            borderColor: '#ef4444',
                            borderDash: [2, 2],
                            pointRadius: 0,
                            fill: false,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            ticks: {
                                stepSize: 50
                            }
                        }
                    }
                }
            });
        }

        function renderBadges() {
            const titles = JSON.parse(localStorage.getItem('typingTitles') || '[]');

            // ãƒãƒƒã‚¸å®šç¾© (IDã¨å¯¾å¿œã™ã‚‹ç§°å·åã®ä¸€éƒ¨)
            const badges = [
                { id: 'badge-syokyu', name: 'åˆç´š1', icon: 'ğŸ”°' },
                { id: 'badge-syokyu2', name: 'åˆç´š2', icon: 'ğŸŒ¿' },
                { id: 'badge-cyukyu1', name: 'ä¸­ç´š', icon: 'ğŸŒ¸' },
                { id: 'badge-jyokyu1', name: 'ä¸Šç´š', icon: 'ğŸ‘‘' }
            ];

            badges.forEach(badge => {
                const el = document.getElementById(badge.id);
                // ã‚¿ã‚¤ãƒˆãƒ«é…åˆ—ã®ä¸­ã«ã€å¯¾è±¡ã®ãƒãƒƒã‚¸åãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const isEarned = titles.some(t => t.includes(badge.name + " åˆæ ¼"));

                if (isEarned) {
                    el.classList.add('active');
                    el.innerHTML = `<span class="badge-icon-small">${badge.icon}</span> ${badge.name}`;
                } else {
                    el.classList.remove('active');
                    el.innerHTML = `<span class="badge-icon-small">${badge.icon}</span> ${badge.name}`;
                }
            });
        }

        function exportData() {
            const data = {
                results: JSON.parse(localStorage.getItem('typingTestResults') || '[]'),
                titles: JSON.parse(localStorage.getItem('typingTitles') || '[]'),
                certs: JSON.parse(localStorage.getItem('typingCerts') || '{}'),
                streak: localStorage.getItem('typingStreak') || 0
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `typing_data_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function triggerImport() {
            document.getElementById('importFile').click();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm("ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¦å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) {
                        if (data.results) localStorage.setItem('typingTestResults', JSON.stringify(data.results));
                        if (data.titles) localStorage.setItem('typingTitles', JSON.stringify(data.titles));
                        if (data.certs) localStorage.setItem('typingCerts', JSON.stringify(data.certs));
                        if (data.streak) localStorage.setItem('typingStreak', data.streak);
                        alert("å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚");
                        location.reload();
                    }
                } catch (err) {
                    alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ­£ã—ã„ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                }
            };
            reader.readAsText(file);
        }

        function clearData() {
            if (confirm("æœ¬å½“ã«å…¨ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå…ƒã«æˆ»ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ï¼‰")) {
                localStorage.clear();
                location.reload();
            }
        }

        window.onload = function () {
            loadData();
            if (window.createKeyboard) {
                createKeyboard();
                const stats = JSON.parse(localStorage.getItem("neotyping_stats") || "{}");
                if (window.applyHeatmap) {
                    applyHeatmap(stats);
                }
            }
        };
    </script>
    <script src="keyboard.js?v=17"></script>
    <script src="start.js?v=17"></script>
</body>

</html>