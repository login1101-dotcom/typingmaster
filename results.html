<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>テスト結果 - ブラインドタッチマスター</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8608202416365177"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="common.css?v=4">
    <link rel="stylesheet" href="start.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .results-container {
            max-width: 600px;
            margin: 40px auto;
            padding: 20px;
        }

        .chart-container {
            background: white;
            padding: 10px 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
            height: 250px;
            /* Fixed height to prevent scrolling */
            position: relative;
        }

        .chart-title {
            font-size: 24px;
            font-weight: bold;
            color: #00796b;
            margin-bottom: 20px;
            text-align: center;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            font-size: 18px;
            color: #999;
        }

        .back-btn {
            display: inline-block;
            padding: 12px 30px;
            background: #00796b;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            margin: 20px 0;
        }

        .back-btn:hover {
            background: #005a4d;
        }

        .clear-btn {
            display: inline-block;
            padding: 12px 30px;
            background: #f44336;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            margin: 20px 10px;
            cursor: pointer;
            border: none;
        }

        .clear-btn:hover {
            background: #d32f2f;
        }

        .control-bar {
            max-width: 600px;
            margin: 10px auto 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .control-bar h1 {
            margin: 0;
            font-size: 20px;
            color: #00796b;
        }

        .control-group {
            display: inline-flex;
            gap: 10px;
            align-items: center;
            /* Remove box styling for cleaner inline look */
            background: transparent;
            box-shadow: none;
            padding: 0;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }

        .filter-item select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        .back-btn,
        .clear-btn {
            padding: 6px 12px;
            margin: 0;
            font-size: 13px;
        }

        /* Stats Dashboard CSS */
        .stats-grid {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: white;
            padding: 8px 20px;
            /* Reduced padding */
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 140px;
            border-top: 4px solid #00796b;
        }

        .stat-value {
            font-size: 26px;
            /* Reduced font size */
            font-weight: bold;
            color: #333;
            margin: 2px 0;
            /* Reduced margin */
            font-family: sans-serif;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            font-weight: bold;
        }

        .stat-card.best .stat-value {
            color: #e65100;
        }

        .stat-card.count .stat-value {
            color: #1565c0;
        }

        .stat-card.latest .stat-value {
            color: #2e7d32;
        }
    </style>
</head>

<body>
    <!-- ナビゲーション -->
    <div class="nav">
        <a href="home.html">ブラインドタッチとは</a> |
        <a href="about.html">このサイトについて</a> |
        <a href="contact.html">お問い合わせ</a> |
        <a href="privacy.html">プライバシーポリシー</a>
        <span id="visit-counter" style="margin-left:10px;">訪問数：--</span>
    </div>

    <div class="control-bar">
        <h1>テスト結果</h1>
        <div class="control-group">
            <a href="index.html" class="back-btn">ホームへ</a>

            <span class="filter-item">
                <select id="levelFilter" onchange="updateChart()">
                    <option value="all">レベル: すべて</option>
                    <option value="syokyu">初級</option>
                    <option value="tyukyu">中級</option>
                    <option value="jyokyu">上級</option>
                </select>
            </span>

            <span class="filter-item">
                <select id="timeLimitFilter" onchange="updateChart()">
                    <option value="all">時間: すべて</option>
                </select>
            </span>

            <button onclick="clearAllData()" class="clear-btn">削除</button>
        </div>
    </div>

    <div class="results-container">
        <!-- 統計ダッシュボード -->
        <div class="stats-grid" id="statsDashboard" style="display:none;">
            <div class="stat-card best">
                <div class="stat-label">自己ベスト</div>
                <div class="stat-value" id="stat-best">--</div>
            </div>
            <div class="stat-card count">
                <div class="stat-label">練習回数</div>
                <div class="stat-value" id="stat-count">--</div>
            </div>
            <div class="stat-card latest">
                <div class="stat-label">直近のスコア</div>
                <div class="stat-value" id="stat-latest">--</div>
            </div>
        </div>
        <div id="noDataMessage" class="no-data" style="display:none;">
            まだテスト結果がありません。<br>
            テストを実行すると、ここに結果が表示されます。
        </div>

        <div id="chartSection" style="display:none;">
            <div class="chart-container">
                <div class="chart-title">得点の推移</div>
                <canvas id="scoreChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let allResults = [];
        let chart = null;

        function loadResults() {
            allResults = JSON.parse(localStorage.getItem('typingTestResults') || '[]');

            if (allResults.length === 0) {
                document.getElementById('noDataMessage').style.display = 'block';
                document.getElementById('chartSection').style.display = 'none';
                return;
            }

            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('chartSection').style.display = 'block';

            // 制限時間の選択肢を生成
            populateTimeLimitFilter();

            // URLパラメータを読み取って自動選択
            const params = new URLSearchParams(window.location.search);
            const levelParam = params.get('level');
            const timeParam = params.get('time');

            if (levelParam) {
                document.getElementById('levelFilter').value = levelParam;
            }

            if (timeParam) {
                document.getElementById('timeLimitFilter').value = timeParam;
            }

            // グラフを表示
            updateChart();
        }

        function populateTimeLimitFilter() {
            const timeLimits = [...new Set(allResults.map(r => r.timeLimit))].sort((a, b) => a - b);
            const select = document.getElementById('timeLimitFilter');

            // 既存のオプションをクリア（「すべて」以外）
            select.innerHTML = '<option value="all">すべて</option>';

            timeLimits.forEach(sec => {
                const option = document.createElement('option');
                option.value = sec;
                const minutes = Math.floor(sec / 60);
                const seconds = sec % 60;
                option.textContent = `${minutes}分${seconds > 0 ? seconds + '秒' : ''}`;
                select.appendChild(option);
            });
        }

        function updateChart() {
            const selectedLevel = document.getElementById('levelFilter').value;
            const selectedTimeLimit = document.getElementById('timeLimitFilter').value;

            // フィルタリング
            let filteredResults = allResults;

            // レベルでフィルター（古いデータの互換性のため、levelがない場合はsyokyuとして扱う）
            if (selectedLevel !== 'all') {
                filteredResults = filteredResults.filter(r => (r.level || 'syokyu') === selectedLevel);
            }

            // 時間でフィルター
            if (selectedTimeLimit !== 'all') {
                filteredResults = filteredResults.filter(r => r.timeLimit == selectedTimeLimit);
            }

            // フィルタリング後にデータがない場合
            if (filteredResults.length === 0) {
                if (chart) {
                    chart.destroy();
                    chart = null;
                }

                // グラフエリアにメッセージを表示
                const ctx = document.getElementById('scoreChart').getContext('2d');
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '20px sans-serif';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('選択した条件に一致するデータがありません', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            // 日付でソート
            filteredResults.sort((a, b) => new Date(a.date) - new Date(b.date));

            // データを準備
            const labels = filteredResults.map(r => {
                const date = new Date(r.date);
                return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
            });

            const scores = filteredResults.map(r => r.score);

            // ★ 統計情報を更新
            if (scores.length > 0) {
                document.getElementById('statsDashboard').style.display = 'flex';
                const best = Math.max(...scores);
                const count = scores.length;
                const latest = scores[scores.length - 1];

                document.getElementById('stat-best').textContent = best;
                document.getElementById('stat-count').textContent = count + '回';
                document.getElementById('stat-latest').textContent = latest;
            } else {
                document.getElementById('statsDashboard').style.display = 'none';
            }

            // グラフを描画
            const ctx = document.getElementById('scoreChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '得点',
                        data: scores,
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, /* Fits to container height */
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function (context) {
                                    const result = filteredResults[context.dataIndex];
                                    const minutes = Math.floor(result.timeLimit / 60);
                                    const seconds = result.timeLimit % 60;
                                    const levelName = (result.level || 'syokyu') === 'syokyu' ? '初級' :
                                        (result.level || 'syokyu') === 'tyukyu' ? '中級' : '上級';
                                    return `レベル: ${levelName}\n制限時間: ${minutes}分${seconds > 0 ? seconds + '秒' : ''}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '得点'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '日時'
                            }
                        }
                    }
                }
            });
        }

        function clearAllData() {
            if (confirm('すべてのテスト結果を削除しますか？\nこの操作は取り消せません。')) {
                localStorage.removeItem('typingTestResults');
                location.reload();
            }
        }

        // ページ読み込み時に実行
        loadResults();
    </script>
    <script src="start.js"></script>
</body>

</html>