<!DOCTYPE html>
<html lang="ja">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QCTM9NEWRK"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-QCTM9NEWRK');
    </script>

    <meta charset="UTF-8">
    <title>æˆé•·åˆ†æãƒœãƒ¼ãƒ‰ - ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒã‚¹ã‚¿ãƒ¼</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="keyboard.css?v=35">
    <link rel="stylesheet" href="common.css?v=35">

    <style>
        body {
            margin: 0 !important;
            padding-top: 0 !important;
            background: #f1f5f9;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
        }

        .dashboard-wrapper {
            max-width: 1100px;
            margin: 10px auto;
            padding: 0 20px 40px 20px;
        }

        /* ä¸‹éƒ¨ã«ä½™ç™½è¿½åŠ  */

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .dashboard-title {
            font-size: 24px;
            font-weight: bold;
            color: #334155;
            min-width: 180px;
        }

        .current-rank-container {
            display: flex;
            justify-content: center;
            flex-grow: 1;
        }

        .rank-display-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: #fff;
            color: #4f46e5;
            border: 2px solid #6366f1;
            padding: 6px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            height: 36px;
            box-sizing: border-box;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .action-area {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .action-btn,
        .reset-btn {
            cursor: pointer;
            font-size: 14px;
            padding: 6px 16px;
            border-radius: 6px;
            height: 36px;
            box-sizing: border-box;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .action-btn:hover {
            filter: brightness(0.95);
        }

        .reset-btn {
            background: #fee2e2;
            border: 1px solid #f87171;
            color: #991b1b;
        }

        .reset-btn:hover {
            background: #fecaca;
        }

        /* ã‚«ãƒ¼ãƒ‰ï¼ˆã‚µã‚¤ã‚ºèª¿æ•´ãƒ»å¼·åˆ¶5åˆ—ï¼‰ */
        .stats-grid {
            display: grid;
            /* ä½•ãŒã‚ã£ã¦ã‚‚5åˆ—ã«ã™ã‚‹ */
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        /* ç”»é¢ãŒç‹­ã™ãã‚‹æ™‚ã ã‘è‡ªå‹•æŠ˜ã‚Šè¿”ã—ã‚’è¨±å¯ã™ã‚‹ï¼ˆã‚¹ãƒãƒ›å¯¾ç­–ï¼‰ */
        @media (max-width: 1000px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            }
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            /* è§’ä¸¸ã‚‚å°‘ã—æ§ãˆã‚ã« */
            padding: 10px 5px;
            /* ä½™ç™½ã‚’å‰Šæ¸› */
            border-top: 4px solid #cbd5e1;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .stat-value {
            font-size: 18px;
            /* å¤§å¹…ã«ç¸®å°ã—ã¦ç¢ºå®Ÿã«åã‚ã‚‹ */
            font-weight: 800;
            color: #1e293b;
            line-height: 1.2;
        }

        .stat-unit {
            font-size: 14px;
            color: #64748b;
            margin-left: 4px;
        }

        .stat-sub {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .card-score .stat-value {
            color: #d97706;
        }

        /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
        .accordion-box {
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .accordion-summary {
            padding: 15px 20px;
            cursor: pointer;
            font-weight: bold;
            color: #475569;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
            list-style: none;
        }

        .accordion-summary::-webkit-details-marker {
            display: none;
        }

        .accordion-summary:hover {
            background: #f1f5f9;
        }

        .accordion-summary::after {
            content: '+';
            font-size: 18px;
            font-weight: bold;
            transition: transform 0.2s;
        }

        details[open] .accordion-summary::after {
            content: '-';
        }

        .accordion-content {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
        }

        /* ãƒãƒ£ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿®æ­£ */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            /* å¼·åˆ¶çš„ã«2åˆ— */
            gap: 20px;
        }

        /* ãƒãƒ£ãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰è‡ªä½“ã¯é«˜ã•å›ºå®šã—ãªã„ */
        .chart-card-wrapper {
            width: 100%;
        }

        /* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¹…æ‹¡å¤§ï¼ˆç”»é¢ã„ã£ã±ã„ä½¿ã†ï¼‰ */
        .index-layout {
            max-width: 100%;
            /* åˆ¶é™è§£é™¤ */
            margin: 0 auto;
            padding: 0 20px;
            /* å°‘ã—ä½™ç™½ */
        }

        /* ã‚³ãƒ³ãƒ†ãƒŠ */
        .chart-box {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .chart-header,
        h4 {
            margin: 0 0 10px 0;
            font-weight: bold;
            text-align: center;
            font-size: 16px;
            color: #475569;
        }

        /* Canvasã‚’å›²ã‚€ãƒ©ãƒƒãƒ‘ãƒ¼ã«é«˜ã•ã‚’æŒ‡å®šã™ã‚‹ */
        .chart-canvas-container {
            position: relative;
            height: 200px;
            /* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«ã™ã‚‹ */
            width: 100%;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 5px;
            margin-top: 10px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #64748b;
            background: #f8fafc;
        }

        .calendar-day.active {
            background: #dcfce7;
            border-color: #86efac;
            color: #166534;
            font-weight: bold;
        }

        .calendar-icon {
            font-size: 16px;
            line-height: 1;
            margin-top: 2px;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        table.data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            text-align: center;
        }

        table.data-table th,
        table.data-table td {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        table.data-table th {
            background-color: #f8fafc;
            color: #475569;
            font-weight: 600;
        }

        .key-badge {
            display: inline-block;
            padding: 2px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #fff;
            font-weight: bold;
            font-family: monospace;
        }

        .heatmap-legend {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            gap: 10px;
            font-size: 14px;
            color: #555;
            padding-bottom: 20px;
        }

        .legend-bar {
            width: 200px;
            height: 12px;
            background: linear-gradient(to right, #ffffff, #e0f2fe, #fef08a, #fdba74, #ef4444);
            border: 1px solid #ccc;
            border-radius: 6px;
        }
    </style>
    <link rel="canonical" href="https://typingmasterneo.com/results.html">
</head>

<body>

    <div class="nav">
        <a href="index.html">Top</a>
        <a href="home.html">ãƒ–ãƒ©ã‚¤ãƒ³ãƒ‰ã‚¿ãƒƒãƒã¨ã¯</a>
        <a href="about.html">ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</a>
        <a href="results.html" style="font-weight:700; color:#2563eb;">æˆé•·åˆ†æãƒœãƒ¼ãƒ‰</a>
        <a href="contact.html">ãŠå•ã„åˆã‚ã›</a>
        <a href="privacy.html">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
        <span id="visit-counter">è¨ªå•æ•°ï¼š--</span>
    </div>

    <div class="index-layout"> <!-- index-layout ã‚’ä½¿ç”¨ã—ã¦å¹…ã‚’æƒãˆã‚‹ -->

        <!-- â˜… ä¸‹éƒ¨ã‚¨ãƒªã‚¢ï¼ˆ3ã‚«ãƒ©ãƒ ãƒ»åºƒå‘Šã‚ã‚Šï¼‰ â˜… -->
        <div class="three-col">

            <!-- å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
            <div class="side-ad">
                <a href="https://px.a8.net/svt/ejp?a8mat=45KHCR+662QYQ+4380+BXQOH" rel="nofollow">
                    <img width="320" height="50"
                        src="https://www23.a8.net/svt/bgt?aid=251218395373&wid=003&eno=01&mid=s00000019080002005000&mc=1">
                </a>

                <a href="https://px.a8.net/svt/ejp?a8mat=45KHCR+6C130I+4K3S+61C2P" rel="nofollow">
                    <img width="336" height="280"
                        src="https://www22.a8.net/svt/bgt?aid=251218395383&wid=003&eno=01&mid=s00000021268001014000&mc=1">
                </a>

                <!-- å¿è€…AdMax -->
                <div
                    style="margin-top: 20px; text-align: center; border: 1px dashed #ccc; padding: 10px; background: #f9f9f9;">
                    <p style="font-size: 12px; color: #666; margin-bottom: 5px;">ã‚¹ãƒãƒ³ã‚µãƒ¼ãƒªãƒ³ã‚¯</p>
                    <div id="ad-space-left-results">
                        <!-- admax -->
                        <script src="https://adm.shinobi.jp/s/5bd4fad41c23169df01e0c4cd2c6bcd4"></script>
                        <!-- admax -->
                    </div>
                </div>
            </div>

            <!-- ä¸­å¤®ã‚¨ãƒªã‚¢ï¼ˆã“ã“ã«æ—¢å­˜ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’å…¥ã‚Œã‚‹ï¼‰ -->
            <div class="center-area" style="width: 100%;">

                <div class="dashboard-header" style="flex-direction: column; justify-content: center; gap: 15px;">
                    <div class="dashboard-title" style="text-align: center; width: 100%;">æˆé•·åˆ†æãƒœãƒ¼ãƒ‰</div>

                    <div
                        style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; align-items: center;">
                        <div class="action-area">
                            <button onclick="exportData()" class="action-btn"
                                style="background:#e0f2fe; border:1px solid #7dd3fc; color:#0369a1;">ãƒ‡ãƒ¼ã‚¿ä¿å­˜(DL)</button>
                            <button onclick="triggerImport()" class="action-btn"
                                style="background:#f0fdf4; border:1px solid #86efac; color:#15803d;">ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ</button>
                            <input type="file" id="importFile" style="display:none;" accept=".json"
                                onchange="importData(this)">
                            <button onclick="clearData()" class="reset-btn">å…¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
                        </div>

                        <div id="rankBadgeDisplay" class="rank-display-badge" style="display:none;">
                            <span>ç¾åœ¨ã®å®ŸåŠ›è©•ä¾¡:</span>
                            <span id="headerRankText">--</span>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card" style="border-top-color: #f59e0b;">
                        <div class="stats-card highlight">
                            <h3>æœ€æ–°ã‚¹ã‚³ã‚¢ (Score)</h3>
                            <div class="value" id="val-score">--</div>
                            <div class="sub-label" id="val-rank">ãƒ©ãƒ³ã‚¯: --</div>
                        </div>
                    </div>
                    <div class="stat-card" style="border-top-color: #64748b;">
                        <div class="stat-label">ç¶™ç¶šå›æ•°</div>
                        <div class="stat-value"><span id="val-count">--</span><span class="stat-unit">å›</span></div>
                        <div class="stat-sub">ç¶™ç¶šã¯åŠ›ãªã‚Šï¼</div>
                    </div>
                    <div class="stat-card" style="border-top-color: #8b5cf6;">
                        <div class="stat-label">ç·ç·´ç¿’æ™‚é–“</div>
                        <div class="stat-value"><span id="val-time">--</span><span class="stat-unit"
                                style="font-size:16px;"></span></div>
                        <div class="stat-sub">ç©ã¿ä¸Šã’ãŸåŠªåŠ›ã®è¨¼</div>
                    </div>
                    <div class="stat-card" style="border-top-color: #3b82f6;">
                        <div class="stat-label">å¹³å‡æ­£ç¢ºç‡</div>
                        <div class="stat-value"><span id="val-acc">--</span><span class="stat-unit">%</span></div>
                        <div class="stat-sub">ç›´è¿‘å¹³å‡ (å®‰å®šæ„Ÿ)</div>
                    </div>
                    <div class="stat-card" style="border-top-color: #10b981;">
                        <div class="stat-label">å¹³å‡ã‚¹ãƒ”ãƒ¼ãƒ‰</div>
                        <div class="stat-value"><span id="val-speed">--</span><span class="stat-unit">key/s</span></div>
                        <div class="stat-sub">é€Ÿã•ã¨æ­£ç¢ºã•ã®ãƒãƒ©ãƒ³ã‚¹</div>
                    </div>
                </div>

                <details class="accordion-box" open>
                    <summary class="accordion-summary">ğŸ“… ç¶™ç¶šçŠ¶æ³ (æ—¥ã€…ã®ç©ã¿ä¸Šã’)</summary>
                    <div class="accordion-content">
                        <div style="margin-bottom:20px;">
                            <div style="font-weight:bold; color:#64748b; margin-bottom:10px;">ç›´è¿‘14æ—¥ã®ç¶™ç¶šãƒã‚§ãƒƒã‚¯ (ğŸ˜Š:OK)</div>
                            <div id="calendarArea" class="calendar-grid"></div>
                        </div>
                    </div>
                </details>

                <details class="accordion-box" open>
                    <summary class="accordion-summary">ğŸ“ˆ å®ŸåŠ›ã®æ¨ç§»ã‚°ãƒ©ãƒ• (è©•ä¾¡å€¤ãƒ»ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ»æ­£ç¢ºç‡)</summary>
                    <div class="accordion-content">
                        <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ (4ã¤) -->
                        <div class="charts-grid">
                            <div class="chart-box">
                                <h4>è©•ä¾¡å€¤ã®æ¨ç§»</h4>
                                <div class="chart-canvas-container">
                                    <canvas id="chartScore"></canvas>
                                </div>
                            </div>
                            <div class="chart-box">
                                <h4>æ­£ç¢ºç‡ã®æ¨ç§»</h4>
                                <div class="chart-canvas-container">
                                    <canvas id="chartAccuracy"></canvas>
                                </div>
                            </div>
                            <div class="chart-box">
                                <h4>ã‚¹ãƒ”ãƒ¼ãƒ‰ã®æ¨ç§»</h4>
                                <div class="chart-canvas-container">
                                    <canvas id="chartSpeed"></canvas>
                                </div>
                            </div>
                            <div class="chart-box">
                                <h4>æ—¥ã”ã¨ã®ç·´ç¿’æ™‚é–“ (åˆ†)</h4>
                                <div class="chart-canvas-container">
                                    <canvas id="chartDailyTime"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>

                <details class="accordion-box">
                    <summary class="accordion-summary">âŒ¨ï¸ è‹¦æ‰‹ã‚­ãƒ¼ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— & åˆ†æè¡¨</summary>
                    <div class="accordion-content">
                        <div id="heatmapSection" style="text-align:center;">
                            <div style="margin-bottom:15px; color:#666;">èµ¤è‰²ãŒæ¿ƒã„ã‚­ãƒ¼ã»ã©ãƒŸã‚¹ãŒå¤šã„ã‚­ãƒ¼ã§ã™</div>
                            <div class="center-card keyboard-card">
                                <div id="keyboardBox"></div>
                            </div>
                            <div class="heatmap-legend">
                                <span>è‰¯ (ç™½)</span>
                                <div class="legend-bar"></div>
                                <span>(èµ¤) è‹¦æ‰‹</span>
                            </div>

                            <div style="margin-top:30px; text-align:left;">
                                <h3
                                    style="font-size:16px; color:#334155; border-left:4px solid #ef4444; padding-left:10px;">
                                    ãƒ¯ãƒ¼ã‚¹ãƒˆã‚­ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚° (ãƒŸã‚¹ã®å¤šã„é †)</h3>
                                <div class="table-container">
                                    <table class="data-table" id="weakKeysTable">
                                        <thead>
                                            <tr>
                                                <th>é †ä½</th>
                                                <th>ã‚­ãƒ¼</th>
                                                <th>ãƒŸã‚¹ç‡</th>
                                                <th>ãƒŸã‚¹å›æ•°</th>
                                                <th>ç·å…¥åŠ›æ•°</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>

                <div id="noData"
                    style="display:none; text-align:center; padding:60px 20px; color:#64748b; margin-top:30px; background:white; border-radius:12px;">
                    ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã¾ãšã¯ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒ†ã‚¹ãƒˆã«æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ï¼<br><br>
                    <a href="index.html" style="color:#3b82f6; text-decoration:underline;">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
                </div>

            </div> <!-- End center-area -->

            <!-- å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
            <div class="side-ad">
                <a href="https://px.a8.net/svt/ejp?a8mat=45KHCR+64VVR6+3ZMA+5ZMCH" rel="nofollow">
                    <img width="320" height="50"
                        src="https://www20.a8.net/svt/bgt?aid=251218395371&wid=003&eno=01&mid=s00000018613001006000&mc=1">
                </a>

                <a href="https://px.a8.net/svt/ejp?a8mat=45KHCR+5RSCG2+2PEO+1I4AW1" rel="nofollow">
                    <img width="300" height="250"
                        src="https://www20.a8.net/svt/bgt?aid=251218395349&wid=003&eno=01&mid=s00000012624009090000&mc=1">
                </a>

                <!-- å¿è€…AdMax -->
                <div
                    style="margin-top: 20px; text-align: center; border: 1px dashed #ccc; padding: 10px; background: #f9f9f9;">
                    <p style="font-size: 12px; color: #666; margin-bottom: 5px;">ã‚¹ãƒãƒ³ã‚µãƒ¼ãƒªãƒ³ã‚¯</p>
                    <div id="ad-space-right-results">
                        <!-- admax -->
                        <script src="https://adm.shinobi.jp/s/5bd4fad41c23169df01e0c4cd2c6bcd4"></script>
                        <!-- admax -->
                    </div>
                </div>
            </div>

        </div> <!-- End three-col -->
    </div> <!-- End index-layout -->

    <script>
        function loadData() {
            const results = JSON.parse(localStorage.getItem('typingTestResults') || '[]');
            const keyStats = JSON.parse(localStorage.getItem("neotyping_stats") || "{}");

            // ã€ç·Šæ€¥å¯¾å¿œã€‘HTMLã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–ï¼šã‚‚ã—å¤ã„ã‚°ãƒ©ãƒ•è¦ç´ ãŒæ®‹ã£ã¦ã„ãŸã‚‰å¼·åˆ¶å‰Šé™¤
            const duplicateCharts = document.querySelectorAll('#chartDailyTime');
            if (duplicateCharts.length > 1) {
                // å¤ã„æ–¹ï¼ˆDOMã®ä¸Šã«ã‚ã‚‹æ–¹ï¼‰ã®è¦ªãƒ©ãƒƒãƒ‘ãƒ¼ã”ã¨å‰Šé™¤
                const oldWrapper = duplicateCharts[0].closest('.chart-card-wrapper');
                if (oldWrapper) {
                    oldWrapper.remove();
                } else {
                    duplicateCharts[0].remove();
                }
            }

            if (results.length === 0) {
                document.querySelector('.stats-grid').style.display = 'none';
                document.querySelectorAll('.accordion-box').forEach(el => el.style.display = 'none');
                document.getElementById('rankBadgeDisplay').style.display = 'none';
                document.getElementById('noData').style.display = 'block';
                return;
            }

            results.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (isNaN(dateA.getTime())) return -1; // æ—¥ä»˜ãªã—ã¯éå»æ‰±ã„
                if (isNaN(dateB.getTime())) return 1;
                return dateA - dateB;
            });
            // ãƒ‡ãƒ¼ã‚¿è£œæ­£ & NaNã‚¬ãƒ¼ãƒ‰
            const stats = results.map(r => {
                let limit = Number(r.timeLimit) || 30;
                let correct = Number(r.correctCount) || 0;
                let total = Number(r.totalKeyStrokes) || Number(r.attemptedCount) || 0;

                let speed = Number(r.speed);
                if (isNaN(speed)) {
                    speed = correct / limit;
                }

                let acc = Number(r.accuracy);
                if (isNaN(acc)) {
                    let denom = total || correct; // åˆ†æ¯ç¢ºä¿
                    acc = denom > 0 ? (correct / denom) * 100 : 0;
                }

                let score = Number(r.score);
                // scoreãŒç„¡åŠ¹ã€ã¾ãŸã¯ã€Œ0ã€ã ãŒå®Ÿã¯ã¡ã‚ƒã‚“ã¨æ‰“ã£ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã®å ´åˆã¯å†è¨ˆç®—
                if (isNaN(score) || (score === 0 && acc > 0 && speed > 0)) {
                    score = Math.round(acc * speed);
                }

                // æœ€çµ‚å®‰å…¨è£…ç½®
                if (isNaN(speed)) speed = 0;
                if (isNaN(acc)) acc = 0;
                if (isNaN(score)) score = 0;

                return { ...r, speed, acc, score, limit };
            }).filter(s => s.totalKeyStrokes > 2 && s.score >= 0); // 3æ‰“ä»¥ä¸Šã®ãƒ‡ãƒ¼ã‚¿ã®ã¿æœ‰åŠ¹ã¨ã™ã‚‹ï¼ˆèª¤æ“ä½œã‚„å³çµ‚äº†ã‚’é™¤å¤–ï¼‰

            if (stats.length === 0) {
                document.querySelector('.stats-grid').style.display = 'none';
                document.querySelectorAll('.accordion-box').forEach(el => el.style.display = 'none');
                document.getElementById('rankBadgeDisplay').style.display = 'none';
                document.getElementById('noData').style.display = 'block';
                return;
            }

            const count = stats.length; // æœ‰åŠ¹ãƒ‡ãƒ¼ã‚¿æ•°

            // æœ€æ–°ã®æœ‰åŠ¹ãƒ‡ãƒ¼ã‚¿ï¼ˆãŸã ã—ã‚¹ã‚³ã‚¢0ã¯ãƒãƒ¼ã‚«ã‚¦ãƒ³ãƒˆæ‰±ã„ã—ã¦ã€ãã®å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¡ç”¨ã™ã‚‹ï¼‰
            let lastStat = stats[count - 1];
            for (let i = count - 1; i >= 0; i--) {
                if (stats[i].score > 0) {
                    lastStat = stats[i];
                    break;
                }
            }

            let rank = "D (æ–°äºº)";
            if (lastStat.score >= 400) rank = "S (é”äºº)";
            else if (lastStat.score >= 300) rank = "A (ãƒ—ãƒ­ç´š)";
            else if (lastStat.score >= 200) rank = "B (ä¸Šç´š)";
            else if (lastStat.score >= 100) rank = "C (æ™®é€š)";

            // æœ€æ–°ã‚¹ã‚³ã‚¢è¡¨ç¤º
            document.getElementById('val-score').textContent = lastStat.score;
            document.getElementById('val-rank').innerHTML = `
                <div>ãƒ©ãƒ³ã‚¯: ${rank}</div>
                <div style="font-size:0.75rem; opacity:0.8; margin-top:4px;">
                    (å†…è¨³: ${Math.round(lastStat.acc)}% Ã— ${lastStat.speed.toFixed(1)} key/s)
                </div>
            `;
            document.getElementById('headerRankText').textContent = `${rank} (Score: ${lastStat.score})`;
            document.getElementById('rankBadgeDisplay').style.display = 'inline-flex';

            document.getElementById('val-count').textContent = count;

            const totalSeconds = stats.reduce((sum, s) => sum + s.limit, 0);
            const totalH = Math.floor(totalSeconds / 3600);
            const totalM = Math.floor((totalSeconds % 3600) / 60);
            document.getElementById('val-time').textContent = (totalH > 0 ? totalH + "æ™‚é–“ " : "") + totalM + "åˆ†";

            document.getElementById('val-acc').textContent = (stats.reduce((s, v) => s + v.acc, 0) / count).toFixed(1);
            document.getElementById('val-speed').textContent = (stats.reduce((s, v) => s + v.speed, 0) / count).toFixed(1);

            // ãƒãƒ£ãƒ¼ãƒˆãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
            renderCharts(stats);
            renderCalendar(stats);
            renderWeakKeyTable(keyStats);

            if (window.createKeyboard) {
                createKeyboard();
                if (window.applyHeatmap) applyHeatmap(keyStats);
            }
        }

        function renderCharts(stats) {
            // ç›´è¿‘14æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã«çµã‚‹
            const fourteenDaysAgo = new Date();
            fourteenDaysAgo.setDate(fourteenDaysAgo.getDate() - 14);

            const recentStats = stats.filter(s => new Date(s.date) >= fourteenDaysAgo);

            const labels = recentStats.map(s => {
                const d = new Date(s.date);
                return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
            });

            createLineChart('chartScore', labels, recentStats.map(s => s.score), 'è©•ä¾¡å€¤', '#f59e0b');
            createLineChart('chartSpeed', labels, recentStats.map(s => s.speed), 'Speed (key/s)', '#10b981');
            createLineChart('chartAccuracy', labels, recentStats.map(s => s.acc), 'æ­£ç¢ºç‡ (%)', '#3b82f6');

            // æ—¥åˆ¥ãƒ—ãƒ¬ã‚¤æ™‚é–“é›†è¨ˆ (ã“ã“ã‚‚14æ—¥åˆ†)
            const dailyTimeMap = {};
            // åˆæœŸåŒ–: ç›´è¿‘14æ—¥åˆ†ã‚’0ã§åŸ‹ã‚ã‚‹
            const today = new Date();
            for (let i = 13; i >= 0; i--) {
                const d = new Date();
                d.setDate(today.getDate() - i);
                const k = d.toISOString().split('T')[0];
                dailyTimeMap[k] = 0;
            }

            stats.forEach(s => { // å…¨ä½“ã®çµ±è¨ˆã‹ã‚‰é›†è¨ˆã—ãªã„ã¨ã€ã‚°ãƒ©ãƒ•ã«ã¯å‡ºãªã„ãŒæ™‚é–“ã¯ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œãªã„ã¨ã„ã‘ãªã„ï¼Ÿã„ã‚„ã‚°ãƒ©ãƒ•ã‚‚14æ—¥åˆ†ã§ã„ã„
                const d = new Date(s.date);
                if (d < fourteenDaysAgo) return;
                const key = d.toISOString().split('T')[0];
                if (dailyTimeMap[key] !== undefined) {
                    dailyTimeMap[key] = (dailyTimeMap[key] || 0) + s.limit;
                }
            });

            const sortedDates = Object.keys(dailyTimeMap).sort();
            // Xè»¸ãƒ©ãƒ™ãƒ«: MM/DDå½¢å¼ã«æƒãˆã‚‹
            const timeLabels = sortedDates.map(d => {
                const date = new Date(d);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            const timeData = sortedDates.map(d => Math.round(dailyTimeMap[d] / 60));

            // ç·´ç¿’æ™‚é–“ã‚‚æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã§è¡¨ç¤º (2è¡Œ2åˆ—ã®4ã¤ç›®)
            createLineChart('chartDailyTime', timeLabels, timeData, 'ç·´ç¿’æ™‚é–“ (åˆ†)', '#a78bfa');
        }

        function createLineChart(id, labels, data, label, color) {
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆãŒã‚ã‚Œã°ç ´æ£„ï¼ˆCanvaså†åˆ©ç”¨ã®ãŸã‚ï¼‰
            const canvas = document.getElementById(id);
            if (Chart.getChart(canvas)) {
                Chart.getChart(canvas).destroy();
            }

            new Chart(canvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: label, data: data, borderColor: color, backgroundColor: color + '20', tension: 0.3, fill: true }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderCalendar(stats) {
            const container = document.getElementById('calendarArea');
            container.innerHTML = "";
            const today = new Date();
            const days = [];
            // 14æ—¥åˆ†
            for (let i = 13; i >= 0; i--) {
                const d = new Date(); d.setDate(today.getDate() - i);
                days.push(d.toISOString().split('T')[0]);
            }
            const activeDays = new Set(stats.map(s => new Date(s.date).toISOString().split('T')[0]));
            days.forEach(dateStr => {
                const isPlayed = activeDays.has(dateStr);
                const el = document.createElement('div');
                el.className = `calendar-day ${isPlayed ? 'active' : 'inactive'}`;
                const md = dateStr.slice(5).replace('-', '/');
                el.innerHTML = `<span>${md}</span><span class="calendar-icon">${isPlayed ? 'ğŸ˜Š' : 'ğŸ˜­'}</span>`;
                container.appendChild(el);
            });
        }

        function renderWeakKeyTable(stats) {
            const tbody = document.querySelector('#weakKeysTable tbody');
            tbody.innerHTML = "";
            const keys = Object.keys(stats).filter(k => stats[k].total >= 5);
            if (keys.length === 0) { tbody.innerHTML = "<tr><td colspan='5'>ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã§ã™</td></tr>"; return; }
            keys.sort((a, b) => (stats[b].miss / stats[b].total) - (stats[a].miss / stats[a].total));
            keys.slice(0, 10).forEach((key, idx) => {
                const d = stats[key];
                const rate = ((d.miss / d.total) * 100).toFixed(1);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${idx + 1}ä½</td><td><span class="key-badge">${key}</span></td>
                    <td style="color:${rate > 20 ? '#ef4444' : '#334155'}"><b>${rate}%</b></td><td>${d.miss}å›</td><td>${d.total}å›</td>`;
                tbody.appendChild(tr);
            });
        }

        window.onload = loadData;
    </script>
    <script src="keyboard.js?v=35"></script>
    <script src="start.js?v=35"></script>
</body>

</html>